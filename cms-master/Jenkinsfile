pipeline {
    agent any

    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timeout(time: 30, unit: 'MINUTES')
    }

    environment {
        PROJECT_ROOT = 'cms-master'

        FRONTEND_DIR = 'cms-master/storyspark-content-hub-main'
        BACKEND_DIR  = 'cms-master/ems-main/backend'
        COMPOSE_FILE = 'cms-master/docker-compose.yml'

        FRONTEND_PORT = '8081'   // corrected port from logs
        BACKEND_PORT  = '8082'
    }

    stages {

        stage('Diagnostics') {
            steps {
                bat """
                echo ==== Jenkins Diagnostics ====
                whoami
                cd
                docker --version
                docker compose version
                """
            }
        }

        stage('Checkout Source Code') {
            steps {
                checkout scm
            }
        }

        stage('Shut Down Old Containers') {
            steps {
                bat "docker compose -f %COMPOSE_FILE% down || ver > nul"
            }
        }

        stage('Build Docker Images') {
            steps {
                bat "docker compose -f %COMPOSE_FILE% build --no-cache"
            }
        }

        stage('Push to Docker Hub') {
            environment {
                DOCKERHUB = credentials('dockerhub')
            }
            steps {
                bat """
                docker login -u %DOCKERHUB_USR% -p %DOCKERHUB_PSW%

                docker tag cms-master-backend %DOCKERHUB_USR%/cms-backend:latest
                docker tag cms-master-frontend %DOCKERHUB_USR%/cms-frontend:latest

                docker push %DOCKERHUB_USR%/cms-backend:latest
                docker push %DOCKERHUB_USR%/cms-frontend:latest
                """
            }
        }

        stage('Deploy Containers') {
            steps {
                bat "docker compose -f %COMPOSE_FILE% up -d"
            }
        }

        stage('Health Check') {
            steps {
                echo "Performing health check..."

                // --- Frontend check ---
                bat """
                powershell -Command "try { (Invoke-WebRequest -Uri http://localhost:%FRONTEND_PORT%/ -UseBasicParsing).StatusCode; Write-Host 'Frontend OK' } catch { Write-Host 'Frontend Failed' }"
                """

                // --- Backend check ---
                bat """
                powershell -Command "try { (Invoke-WebRequest -Uri http://localhost:%BACKEND_PORT%/actuator/health -UseBasicParsing).StatusCode; Write-Host 'Backend OK' } catch { Write-Host 'Backend Failed' }"
                """
            }
        }
    }  // END stages

    post {
        success {
            echo "ðŸŽ‰ Deployment SUCCESS!"
            echo "Frontend â†’ http://localhost:${env.FRONTEND_PORT}"
            echo "Backend  â†’ http://localhost:${env.BACKEND_PORT}"
        }

        failure {
            echo "âŒ Deployment FAILED â€” showing logs..."
            bat "docker compose -f %COMPOSE_FILE% logs --no-color --tail=200 || ver > nul"
        }
    }
} // END pipeline
