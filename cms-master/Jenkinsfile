pipeline {
    agent any

    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timeout(time: 30, unit: 'MINUTES')
    }

    environment {

        // Root project folder inside the repo
        PROJECT_ROOT = 'cms-master'

        // Correct paths based on your repo
        FRONTEND_DIR = 'cms-master/storyspark-content-hub-main'
        BACKEND_DIR  = 'cms-master/ems-main/backend'
        COMPOSE_FILE = 'cms-master/docker-compose.yml'

        // Ports from your Docker Desktop setup
        FRONTEND_PORT = '8085'
        BACKEND_PORT  = '8082'
    }

    stages {

        /* ----------------------------------------------------------- */
        stage('Diagnostics') {
            steps {
                bat """
                echo ==== Jenkins Diagnostics ====
                whoami
                cd
                docker --version
                docker compose version
                """
            }
        }

        /* ----------------------------------------------------------- */
        stage('Checkout Source Code') {
            steps {
                checkout scm
            }
        }

        /* ----------------------------------------------------------- */
        stage('Shut Down Old Containers') {
            steps {
                bat "docker compose -f %COMPOSE_FILE% down || ver > nul"
            }
        }

        /* ----------------------------------------------------------- */
        stage('Build Docker Images') {
            steps {
                bat "docker compose -f %COMPOSE_FILE% build --no-cache"
            }
        }

        /* ----------------------------------------------------------- */
        stage('Push to Docker Hub') {
           environment {
    DOCKERHUB = credentials('dockerhub')
  }
  steps {
    bat """
      docker login -u %DOCKERHUB_USR% -p %DOCKERHUB_PSW%

      docker tag cms-master-backend %DOCKERHUB_USR%/cms-backend:latest
      docker tag cms-master-frontend %DOCKERHUB_USR%/cms-frontend:latest

      docker push %DOCKERHUB_USR%/cms-backend:latest
      docker push %DOCKERHUB_USR%/cms-frontend:latest
    """
  }
            }
        }

        /* ----------------------------------------------------------- */
        stage('Deploy Containers') {
            steps {
                bat "docker compose -f %COMPOSE_FILE% up -d"
            }
        }

        /* ----------------------------------------------------------- */
        stage('Health Check') {
            steps {
                bat 'powershell -Command "Start-Sleep -Seconds 5"'

                // Frontend Health
                bat """
                powershell -Command "
                Try {
                    Invoke-WebRequest http://localhost:%FRONTEND_PORT%/ -UseBasicParsing | Out-Null;
                    Write-Host 'Frontend OK';
                } Catch {
                    Write-Host 'Frontend FAILED';
                }"
                """

                // Backend Health
                bat """
                powershell -Command "
                Try {
                    Invoke-WebRequest http://localhost:%BACKEND_PORT%/actuator/health -UseBasicParsing | Out-Null;
                    Write-Host 'Backend OK';
                } Catch {
                    Write-Host 'Backend FAILED';
                }"
                """
            }
        }
    } // end stages

    /* ----------------------------------------------------------- */
    post {
        success {
            echo "ðŸŽ‰ Deployment SUCCESS!"
            echo "Frontend â†’ http://localhost:${env.FRONTEND_PORT}"
            echo "Backend  â†’ http://localhost:${env.BACKEND_PORT}"
        }

        failure {
            echo "âŒ Deployment FAILED â€” showing logs..."
            bat "docker compose -f %COMPOSE_FILE% logs --no-color --tail=200 || ver > nul"
        }
    }


