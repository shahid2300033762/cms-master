pipeline {
  agent any

  environment {
    PROJECT_ROOT = 'cms-master'             // ✔ your repo root folder
    COMPOSE_FILE = 'cms-master/docker-compose.yml'   // ✔ correct path

    FRONTEND_DIR = 'cms-master/storyspark-content-hub-main'
    BACKEND_DIR  = 'cms-master/ems-main/backend'

    FRONTEND_PORT = '8085'
    BACKEND_PORT  = '8082'

    DOCKER_USER = 'YOUR_DOCKERHUB_USERNAME'
    DOCKER_PASS = 'YOUR_DOCKERHUB_PASSWORD'
  }

  stages {

    stage('Diagnostics') {
      steps {
        bat 'echo ==== Jenkins diagnostics ===='
        bat 'whoami'
        bat 'cd'
        bat 'docker --version'
        bat 'docker compose version'
      }
    }

    stage('Pre-clean') {
      steps {
        bat "docker compose -f %COMPOSE_FILE% down || ver > nul"
      }
    }

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Docker Images') {
      steps {
        bat "docker compose -f %COMPOSE_FILE% build --no-cache"
      }
    }

    stage('Push to Docker Hub') {
      steps {
        bat """
          docker login -u %DOCKER_USER% -p %DOCKER_PASS%
          docker tag cms-master-backend %DOCKER_USER%/cms-backend:latest
          docker tag cms-master-frontend %DOCKER_USER%/cms-frontend:latest
          docker push %DOCKER_USER%/cms-backend:latest
          docker push %DOCKER_USER%/cms-frontend:latest
        """
      }
    }

    stage('Deploy') {
      steps {
        bat "docker compose -f %COMPOSE_FILE% up -d"
      }
    }

    stage('Health Check') {
      steps {
        bat 'powershell -Command "Start-Sleep -Seconds 5"'
        bat 'powershell -Command "Invoke-WebRequest http://localhost:%FRONTEND_PORT%/"'
        bat 'powershell -Command "Invoke-WebRequest http://localhost:%BACKEND_PORT%/actuator/health"'
      }
    }

  }

  post {
    success {
      echo "Deployment SUCCESS"
    }
    failure {
      echo "Deployment FAILED. Showing logs..."
      bat "docker compose -f %COMPOSE_FILE% logs --no-color --tail=200"
    }
  }
}
